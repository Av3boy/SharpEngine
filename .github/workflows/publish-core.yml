name: Publish Core to NuGet

on:
  push:
    branches:
      - '**'
    paths:
      - 'Core/**'
      - '.github/workflows/publish-nuget.yml'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      RUN_TAG_STEP: true

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'

    - name: Generate new semantic version
      id: version
      uses: mathieudutour/github-tag-action@v6.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        release_branches: main
        pre_release_branches: ".*"
        dry_run: true

    - name: Patch version in .csproj
      run: |
        csproj_file="Core/SharpEngine.Core.csproj"
        version="${{ steps.version.outputs.new_version }}"
        echo "Setting version to $version in $csproj_file"
        sed -i "s|<Version>.*</Version>|<Version>$version</Version>|" "$csproj_file"
      shell: bash

    #- name: Build Project
    #  run: dotnet build Core/SharpEngine.Core.csproj --configuration Release

    #- name: Pack NuGet Package
    #  run: dotnet pack Core/SharpEngine.Core.csproj --configuration Release --no-build -o ./nupkgs

    #- name: Push Package to NuGet
    #  run: dotnet nuget push ./nupkgs/*.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.PUBLISH_NUGET_PACKAGE }}

    # - name: Publish package in github
    #   run: echo "Publishing package"

    # Tagging already handled by github-tag-action
    # - name: Create Git Tag for New Version
    #   if: env.RUN_TAG_STEP == 'true'
    #   run: ...

    # - name: Publish Launcher and Editor zip
    #   run: echo "Publishing Launcher and Editor zip"
